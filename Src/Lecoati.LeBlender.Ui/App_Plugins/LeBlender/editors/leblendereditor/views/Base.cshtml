@using Umbraco.Core;
@using Umbraco.Core.Composing;
@using Umbraco.Core.Cache;
@using System.Web.Mvc;
@using System.Web.Mvc.Html;
@using Lecoati.LeBlender.Extension;
@using Lecoati.LeBlender.Extension.Models;

@inherits WebViewPage<dynamic>

@try
{
    var helper = new Helper();
    string guid = Model.guid != null && Model.guid.Value != null ? Model.guid.Value.ToString() : "";
    LeBlenderModel blenderModel = helper.DeserializeBlenderModel( Model );
    var editorAlias = (string)Model.editor.alias;
    var gridEditorConfig = Current.AppCaches.RuntimeCache.GetCacheItem( "Leblender.EditorConfig." + editorAlias, () =>
    {
        var gridConfig = Current.Configs.Grids().EditorsConfig;
        return gridConfig.Editors.FirstOrDefault( ge => ge.Alias == editorAlias );
    }, TimeSpan.FromMinutes( 15 ) );

    var frontView = gridEditorConfig?.Config["frontView"] ?? editorAlias;

    ViewDataDictionary datas = new ViewDataDictionary() { { "editorAlias", editorAlias }, { "frontView", frontView } };
    if (Model.contentId != null)
    {
        datas.Add( "contentId", (int)Model.contentId );
    }

    var keys = ViewData.Keys.Where( k =>
         !datas.Keys.Any( x => x == k )
    );
    // Add the keys from ViewData to the new Dictionary
    foreach (var key in keys)
    {
        datas.Add( key, ViewData[key] );
    }

    int cacheExpiration = helper.GetCacheExpiration( editorAlias );

    if (cacheExpiration > 0 && helper.IsFrontEnd())
    {
        <text>
            @LeBlenderPartialCacher.LeBlenderCachedPartial( Html, "/App_Plugins/LeBlender/editors/leblendereditor/views/LeBlender.cshtml", blenderModel, cacheExpiration, guid, datas )
        </text>
    }
    else
    {
        <text>
            @Html.Partial( "/App_Plugins/LeBlender/editors/leblendereditor/views/LeBlender.cshtml", blenderModel, datas )
        </text>
    }

}
catch (Exception ex)
{
    if (!new Helper().IsFrontEnd())
    {
        <p class="red">Something went wrong with this editor, below is the exception detail:</p>
    }
    <p class="leblender-exception">@ex.ToString()</p>
}
